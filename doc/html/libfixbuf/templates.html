<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libfixbuf: Template Definition</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Template Definition </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a class="anchor" id="md_doc_templates"></a> </p>
<h1><a class="anchor" id="define-templates"></a>
How-To Define Templates</h1>
<p >As mention previously, you must define an internal and external <a class="el" href="public_8h.html#a1a98b02ac2e3547d96e839174270af99">fbTemplate_t</a> to describe each record you want to write, and you must define an internal Template that describes each record you want to read (the external Templates are defined by the incoming data).</p>
<p >An internal Template represents the layout of the record in your application, and the external Template represents the layout of the record in the IPFIX stream. The internal and external Templates do not have to match. libfixbuf copies the common fields, ignores extra fields in the source Template, and zeroes extra fields in the destination.</p>
<p ><a class="el" href="public_8h.html#ad29df497298e072387af52c3a758f268" title="Allocates a new empty template.">fbTemplateAlloc()</a> allocates a Template. Typically one uses <a class="el" href="public_8h.html#afdf4a52e9f867433d46a1d4d8ec4bc8f" title="Appends information elements described by a specifier array to a template.">fbTemplateAppendSpecArray()</a> or <a class="el" href="public_8h.html#a929bf7b453495c42935614fbd0b57d50" title="Appends information elements described by a specifier array to a template.">fbTemplateAppendArraySpecId()</a> to define the information elements in a Template. libfixbuf uses the <a class="el" href="public_8h.html#a14584138b2d3c57189522d818d8fec6f">fbTemplateField_t</a> type to represent an information element that appears in a Template.</p>
<p ><a class="el" href="public_8h.html#a5a23a76ff4edff6616b5db2fbd63644f" title="Adds a Template to a Session.">fbSessionAddTemplate()</a> and <a class="el" href="public_8h.html#a525465e592ae165c0460f0fade217080" title="Adds a Template to a Session being used for export as both an internal template and an external templ...">fbSessionAddTemplatesForExport()</a> add the Template to an <a class="el" href="public_8h.html#a8441ccbdab7eaccc081dae0e3af32855">fbSession_t</a>. Templates use internal reference counting, so they may be added to multiple Sessions, to the same Session using multiple template IDs or multiple observation domains, or as both an internal and an external Template on the same session.</p>
<p >The layout of the template usually matches the C <code>struct</code> that holds the record. Any gaps (due to alignment) in the C <code>struct</code> must be noted in both the data structure and the template.</p>
<p >Example code:  </p><div class="fragment"><div class="line">    <a class="code hl_struct" href="public_8h.html#structfb_info_element_spec__st">fbInfoElementSpec_t</a> collectTemplate[] = {</div>
<div class="line">        {<span class="stringliteral">&quot;flowStartMilliseconds&quot;</span>,               8, 0 },</div>
<div class="line">        {<span class="stringliteral">&quot;flowEndMilliseconds&quot;</span>,                 8, 0 },</div>
<div class="line">        {<span class="stringliteral">&quot;sourceIPv4Address&quot;</span>,                   4, 0 },</div>
<div class="line">        {<span class="stringliteral">&quot;destinationIPv4Address&quot;</span>,              4, 0 },</div>
<div class="line">        {<span class="stringliteral">&quot;sourceTransportPort&quot;</span>,                 2, 0 },</div>
<div class="line">        {<span class="stringliteral">&quot;destinationTransportPort&quot;</span>,            2, 0 },</div>
<div class="line">        {<span class="stringliteral">&quot;protocolIdentifier&quot;</span>,                  1, 0 },</div>
<div class="line">        {<span class="stringliteral">&quot;paddingOctets&quot;</span>,                       3, 0 },</div>
<div class="line">        {<span class="stringliteral">&quot;packetTotalCount&quot;</span>,                    8, 0 },</div>
<div class="line">        {<span class="stringliteral">&quot;octetTotalCount&quot;</span>,                     8, 0 },</div>
<div class="line">        {<span class="stringliteral">&quot;ipPayloadPacketSection&quot;</span>,              0, 0 },</div>
<div class="line">        <a class="code hl_define" href="public_8h.html#ae7f1800b8e6f3d6461798f9c9c6127a1">FB_IESPEC_NULL</a></div>
<div class="line">    };</div>
<div class="line">    <span class="keyword">struct </span>collectRecord_st {</div>
<div class="line">        uint64_t      flowStartMilliseconds;</div>
<div class="line">        uint64_t      flowEndMilliseconds;</div>
<div class="line">        uint32_t      sourceIPv4Address;</div>
<div class="line">        uint32_t      destinationIPv4Address;</div>
<div class="line">        uint16_t      sourceTransportPort;</div>
<div class="line">        uint16_t      destinationTransportPort;</div>
<div class="line">        uint8_t       protocolIdentifier;</div>
<div class="line">        uint8_t       padding[3];</div>
<div class="line">        uint64_t      packetTotalCount;</div>
<div class="line">        uint64_t      octetTotalCount;</div>
<div class="line">        <a class="code hl_struct" href="public_8h.html#structfb_varfield__st">fbVarfield_t</a>  payload;</div>
<div class="line">    } collectRecord;</div>
<div class="ttc" id="apublic_8h_html_ae7f1800b8e6f3d6461798f9c9c6127a1"><div class="ttname"><a href="public_8h.html#ae7f1800b8e6f3d6461798f9c9c6127a1">FB_IESPEC_NULL</a></div><div class="ttdeci">#define FB_IESPEC_NULL</div><div class="ttdoc">Convenience macro defining a null information element specification initializer (fbInfoElementSpec_t)...</div><div class="ttdef"><b>Definition:</b> public.h:1596</div></div>
<div class="ttc" id="apublic_8h_html_structfb_info_element_spec__st"><div class="ttname"><a href="public_8h.html#structfb_info_element_spec__st">fbInfoElementSpec_st</a></div><div class="ttdoc">A single IPFIX Information Element specification.</div><div class="ttdef"><b>Definition:</b> public.h:1606</div></div>
<div class="ttc" id="apublic_8h_html_structfb_varfield__st"><div class="ttname"><a href="public_8h.html#structfb_varfield__st">fbVarfield_st</a></div><div class="ttdoc">A variable-length field value.</div><div class="ttdef"><b>Definition:</b> public.h:147</div></div>
<div class="line">    tmpl = <a class="code hl_function" href="public_8h.html#ad29df497298e072387af52c3a758f268">fbTemplateAlloc</a>(model);</div>
<div class="line">    <span class="keywordflow">if</span> (!<a class="code hl_function" href="public_8h.html#afdf4a52e9f867433d46a1d4d8ec4bc8f">fbTemplateAppendSpecArray</a>(tmpl, collectTemplate, ~0, &amp;err))</div>
<div class="line">        FATAL(err);</div>
<div class="ttc" id="apublic_8h_html_ad29df497298e072387af52c3a758f268"><div class="ttname"><a href="public_8h.html#ad29df497298e072387af52c3a758f268">fbTemplateAlloc</a></div><div class="ttdeci">fbTemplate_t * fbTemplateAlloc(fbInfoModel_t *model)</div><div class="ttdoc">Allocates a new empty template.</div></div>
<div class="ttc" id="apublic_8h_html_afdf4a52e9f867433d46a1d4d8ec4bc8f"><div class="ttname"><a href="public_8h.html#afdf4a52e9f867433d46a1d4d8ec4bc8f">fbTemplateAppendSpecArray</a></div><div class="ttdeci">gboolean fbTemplateAppendSpecArray(fbTemplate_t *tmpl, const fbInfoElementSpec_t *spec, uint32_t wantedFlags, GError **err)</div><div class="ttdoc">Appends information elements described by a specifier array to a template.</div></div>
<div class="line">    <span class="keywordflow">if</span> (!(tid = <a class="code hl_function" href="public_8h.html#a5a23a76ff4edff6616b5db2fbd63644f">fbSessionAddTemplate</a>(</div>
<div class="line">              session, TRUE, <a class="code hl_define" href="public_8h.html#a243165c146a8fbda7e0902a06abce6a4">FB_TID_AUTO</a>, tmpl, NULL, &amp;err)))</div>
<div class="line">        FATAL(err);</div>
<div class="ttc" id="apublic_8h_html_a243165c146a8fbda7e0902a06abce6a4"><div class="ttname"><a href="public_8h.html#a243165c146a8fbda7e0902a06abce6a4">FB_TID_AUTO</a></div><div class="ttdeci">#define FB_TID_AUTO</div><div class="ttdoc">Template ID argument used when adding an fbTemplate_t to an fbSession_t that automatically assigns a ...</div><div class="ttdef"><b>Definition:</b> public.h:1574</div></div>
<div class="ttc" id="apublic_8h_html_a5a23a76ff4edff6616b5db2fbd63644f"><div class="ttname"><a href="public_8h.html#a5a23a76ff4edff6616b5db2fbd63644f">fbSessionAddTemplate</a></div><div class="ttdeci">uint16_t fbSessionAddTemplate(fbSession_t *session, gboolean internal, uint16_t tid, fbTemplate_t *tmpl, fbTemplateInfo_t *tmplInfo, GError **err)</div><div class="ttdoc">Adds a Template to a Session.</div></div>
</div><!-- fragment --><p> The argument to <a class="el" href="public_8h.html#afdf4a52e9f867433d46a1d4d8ec4bc8f" title="Appends information elements described by a specifier array to a template.">fbTemplateAppendSpecArray()</a> is an array of <a class="el" href="public_8h.html#a337ab69da423d123e6947eed140d80e2">fbInfoElementSpec_t</a> definitions. Typically the array is a static definition. The fbInfoElementSpec_t includes the name of the <a class="el" href="public_8h.html#a8b602092d4c0a9ae3727445eb45acf3c">fbInfoElement_t</a>, the length for the element in this template, and a <code>flags</code> value. The argument to <a class="el" href="public_8h.html#a929bf7b453495c42935614fbd0b57d50" title="Appends information elements described by a specifier array to a template.">fbTemplateAppendArraySpecId()</a> is an array of <a class="el" href="public_8h.html#a538b4beea07a1a9b211c7c8efdaf9083">fbInfoElementSpecId_t</a> definitions. An fbInfoElementSpecId_t is similar to an fbInfoElementSpec_t except it uses the element's numeric identifier and private enterprise number (PEN).</p>
<p >The <code>flags</code> value allows creation of multiple Templates from a single fbInfoElementSpec_t array. The Template-building functions <a class="el" href="public_8h.html#afdf4a52e9f867433d46a1d4d8ec4bc8f" title="Appends information elements described by a specifier array to a template.">fbTemplateAppendSpecArray()</a>, <a class="el" href="public_8h.html#aa26aa2d6a6b57dba79d2b5742b4a7540" title="Potentially appends an information element described by the specifier to a template.">fbTemplateAppendSpec()</a>, <a class="el" href="public_8h.html#a929bf7b453495c42935614fbd0b57d50" title="Appends information elements described by a specifier array to a template.">fbTemplateAppendArraySpecId()</a>, and <a class="el" href="public_8h.html#a0cc72100c8e770251817db64ef8edc7d" title="Potentially appends an information element described by the specifier to a template.">fbTemplateAppendSpecId()</a> as well as the Template-querying function <a class="el" href="public_8h.html#a3bd13adb0434e8315a371531556d1e91" title="Determines if a template contains at least one instance of each information element in a given inform...">fbTemplateContainsAllFlaggedElementsByName()</a> take a parameter named <code>wantedFlags</code>. The two values are used as follows:</p>
<ul>
<li>If an <a class="el" href="public_8h.html#a337ab69da423d123e6947eed140d80e2">fbInfoElementSpec_t</a>'s or <a class="el" href="public_8h.html#a538b4beea07a1a9b211c7c8efdaf9083">fbInfoElementSpecId_t</a> <code>flags</code> is 0, the spec is always included in the Template.</li>
<li>When a spec's <code>flags</code> value is non-zero, the spec is used only if the spec's <code>flags</code> intersected with (bit-wise AND) the function's <code>wantedFlags</code> parameter equals the spec's <code>flags</code>. That is, the high bits of the <code>wantedFlags</code> parameter must include all the high bits of the spec's <code>flags</code>.</li>
</ul>
<p >In general, the <code>flags</code> member of an <a class="el" href="public_8h.html#a337ab69da423d123e6947eed140d80e2">fbInfoElementSpec_t</a> or <a class="el" href="public_8h.html#a538b4beea07a1a9b211c7c8efdaf9083">fbInfoElementSpecId_t</a> should have few high bits. The functions' <code>wantedFlags</code> parameter generally contains multiple high bits to include multiple specs. Consider this spec array:</p>
<div class="fragment"><div class="line"><a class="code hl_struct" href="public_8h.html#structfb_info_element_spec__st">fbInfoElementSpec_t</a> spec_array[] = {</div>
<div class="line">    {<span class="stringliteral">&quot;protocolIdentifier&quot;</span>,       1,  0},</div>
<div class="line">    {<span class="stringliteral">&quot;paddingOctets&quot;</span>,            3,  8},</div>
<div class="line">    {<span class="stringliteral">&quot;sourceTransportPort&quot;</span>,      2,  1},</div>
<div class="line">    {<span class="stringliteral">&quot;destinationTransportPort&quot;</span>, 2,  1},</div>
<div class="line">    {<span class="stringliteral">&quot;paddingOctets&quot;</span>,            5, 16},</div>
<div class="line">    {<span class="stringliteral">&quot;icmpTypeIPv4&quot;</span>,             1,  2},</div>
<div class="line">    {<span class="stringliteral">&quot;icmpCodeIPv4&quot;</span>,             1,  2},</div>
<div class="line">    {<span class="stringliteral">&quot;icmpTypeIPv6&quot;</span>,             1,  4},</div>
<div class="line">    {<span class="stringliteral">&quot;icmpCodeIPv6&quot;</span>,             1,  4},</div>
<div class="line">    <a class="code hl_define" href="public_8h.html#ae7f1800b8e6f3d6461798f9c9c6127a1">FB_IESPEC_NULL</a></div>
<div class="line">};</div>
</div><!-- fragment --><p >The protocol is included in every template since its <code>flags</code> value is 0. The ports are included when the <code>wantedFlags</code> parameter has a 1 in bit position 1. When building a template that maps to the following C <code>struct</code> (where padding is necessary for member alignment), <code>wantedFlags</code> should be 9 <code>(1 | 8)</code>.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>proto_ports = {</div>
<div class="line">    uint8_t   protocol;</div>
<div class="line">    uint8_t   padding[3];</div>
<div class="line">    uint16_t  source_port;</div>
<div class="line">    uint16_t  dest_port;</div>
<div class="line">};</div>
</div><!-- fragment --><p >For ICMP records, <code>wantedFlags</code> should have a 1 in position 2 or 4 depending on whether the record is IPv4 or IPv6, respectively. To map the template to the following <code>struct</code>, <code>wantedFlags</code> should be 18 <code>(2 | 16)</code> for IPv4 and 20 <code>(4 | 16)</code> for IPv6.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>proto_ports = {</div>
<div class="line">    uint8_t   protocol;</div>
<div class="line">    uint8_t   padding[5];</div>
<div class="line">    uint8_t   icmp_type;</div>
<div class="line">    uint8_t   icmp_code;</div>
<div class="line">};</div>
</div><!-- fragment --><p >When writing these records, including the padding would make them larger than necessary. You could eliminate the padding by defining external Templates that do not include it: Use 1, 2, or 4 for the <code>wantedFlags</code> parameter to <a class="el" href="public_8h.html#a5a23a76ff4edff6616b5db2fbd63644f" title="Adds a Template to a Session.">fbSessionAddTemplate()</a>. (In libfixbuf-3.0.0, you may also use <a class="el" href="public_8h.html#ae948b91015d10eefd58179d6e6eff5f3" title="Creates a new template that is a copy of tmpl perhaps modified by the values specified in flags.">fbTemplateCopy()</a> or <a class="el" href="public_8h.html#a525465e592ae165c0460f0fade217080" title="Adds a Template to a Session being used for export as both an internal template and an external templ...">fbSessionAddTemplatesForExport()</a>.)</p>
<p >To query whether an incoming template matches these <code>struct</code>s, use <a class="el" href="public_8h.html#a3bd13adb0434e8315a371531556d1e91" title="Determines if a template contains at least one instance of each information element in a given inform...">fbTemplateContainsAllFlaggedElementsByName()</a>. To avoid testing for the presence of the padding, use 1, 2, or 4 for its <code>wantedFlags</code> parameter.</p>
<p >If you pass 0 as the value for <code>wantedFlags</code>, you only get elements where the <code>flags</code> value of the fbInfoElementSpec_t is 0. To get all elements, ensure all bits of <code>wantedFlags</code> are high by passing <code>0xffffffff</code>, <code>UINT32_MAX</code>, or <code>~0</code>.</p>
<p >Previous: <a href="read.html">IPFIX File Collectors</a> | Next: <a href="collect.html">Network Collectors</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</body>
</html>
